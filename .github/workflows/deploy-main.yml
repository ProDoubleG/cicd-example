name: CD - Blue/Green Deployment (Main)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-blue-green:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ í†µê³¼)
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
            docker network create test-net
          }

      # 2. í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Production Image
        run: docker build --target production -t my-app:prod -f app/Dockerfile .

      # 3. [í•µì‹¬] Blue/Green ë°°í¬ ì „ëµ ì‹¤í–‰
      - name: Blue/Green Deployment Strategy
        run: |
          # ----------------------------------------------------------------
          # [Step A] íƒ€ê²Ÿ ê²°ì •
          # ----------------------------------------------------------------
          Write-Host "Determining Deployment Target..."

          $BlueStatus = docker ps -q -f name=app-blue
          
          if ($BlueStatus) {
            Write-Host "Blue is Active -> Target: Green"
            $TargetColor = "green"
            $TargetPort = "5002"
          } else {
            Write-Host "Blue is Inactive -> Target: Blue"
            $TargetColor = "blue"
            $TargetPort = "5001"
          }

          $NewContainerName = "app-$TargetColor"
          
          # ----------------------------------------------------------------
          # [Step B] ë°°í¬ ì‹¤í–‰ (ëª…ì°°: Deployment Server)
          # ----------------------------------------------------------------
          Write-Host "    Deploying $NewContainerName on port $TargetPort..."

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
          if (docker ps -a -q -f name=$NewContainerName) {
            docker rm -f $NewContainerName
          }

          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d --name $NewContainerName `
            --network test-net `
            -p ${TargetPort}:5000 `
            -e Page_Title="Deployment Server" `
            --restart always `
            my-app:prod

          Write-Host "    Waiting for container initialization..."
          Start-Sleep -Seconds 5

          # ----------------------------------------------------------------
          # [Step C] ì„¤ì • íŒŒì¼ êµì²´ (Writeê°€ ì•„ë‹ˆë¼ Copy!)
          # ----------------------------------------------------------------
          
          # ê¹ƒí—™ì—ì„œ ë°›ì•„ì˜¨ ì†ŒìŠ¤ íŒŒì¼ ê²½ë¡œ (blue.conf ë˜ëŠ” green.conf)
          # $TargetColor ë³€ìˆ˜ì— ë”°ë¼ blue.conf í˜¹ì€ green.confê°€ ì„ íƒë¨
          $SourceFile = "nginx\templates\$TargetColor.conf"
          
          # ì‹¤ì œë¡œ Nginxê°€ ë°”ë¼ë³´ê³  ìˆëŠ” íŒŒì¼ ê²½ë¡œ (ë®ì–´ì”Œì›Œì§ˆ íŒŒì¼)
          $DestFile = "C:\Users\answn\workspace\cicd_practice\nginx\myapp.conf"
          
          Write-Host "    Copying Config: $SourceFile -> $DestFile"
          
          # [í•µì‹¬] íŒŒì¼ ë³µì‚¬ (ë®ì–´ì“°ê¸°)
          Copy-Item -Path $SourceFile -Destination $DestFile -Force

          # ----------------------------------------------------------------
          # [Step D] Nginx Reload
          # ----------------------------------------------------------------
          Write-Host "    Reloading Nginx..."
          
          docker exec nginx-proxy nginx -t
          if ($LASTEXITCODE -eq 0) {
              docker exec nginx-proxy nginx -s reload
              Write-Host "    SUCCESS: Traffic switched to $NewContainerName"
          } else {
              Write-Error "    Nginx Config Check Failed!"
              exit 1
          }

          # ----------------------------------------------------------------
          # [Step E] êµ¬ë²„ì „ ì‚­ì œ (ì„ íƒ ì‚¬í•­)
          # ----------------------------------------------------------------
          # ë°˜ëŒ€í¸ ìƒ‰ê¹” êµ¬í•˜ê¸°
          if ($TargetColor -eq "blue") { $OldColor = "green" } else { $OldColor = "blue" }
          $OldContainerName = "app-$OldColor"

          if (docker ps -a -q -f name=$OldContainerName) {
            Write-Host "ğŸ—‘ï¸ Removing old container: $OldContainerName"
            docker stop $OldContainerName
            docker rm $OldContainerName
          }