name: CD - Blue/Green Deployment (Main)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-blue-green:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ í†µê³¼)
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
            docker network create test-net
          }

      # 2. í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Production Image
        run: docker build --target production -t my-app:prod -f app/Dockerfile .

      # 3. [í•µì‹¬] Blue/Green ë°°í¬ ì „ëµ ì‹¤í–‰
      - name: Blue/Green Deployment Strategy
        run: |
          # ----------------------------------------------------------------
          # [Step A] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸ (ëˆ„ê°€ ë²”ì¸ì¸ê°€?)
          # ----------------------------------------------------------------
          # app-blueê°€ ì‚´ì•„ìˆìœ¼ë©´ -> ë‹¤ìŒ íƒ€ê²Ÿì€ Green
          # app-greenì´ ì‚´ì•„ìˆê±°ë‚˜ ë‘˜ ë‹¤ ì—†ìœ¼ë©´ -> ë‹¤ìŒ íƒ€ê²Ÿì€ Blue (ê¸°ë³¸ê°’)
          
          $BlueStatus = docker ps -q -f name=app-blue
          if ($BlueStatus) {
            $TargetColor = "green"
            $TargetPort = "5002"
            $OldColor = "blue"
          } else {
            $TargetColor = "blue"
            $TargetPort = "5001"
            $OldColor = "green"
          }

          $NewContainerName = "app-$TargetColor"
          $OldContainerName = "app-$OldColor"

          Write-Host "ğŸ”µ Current Active: $OldContainerName"
          Write-Host "ğŸŸ¢ Target Deploy: $NewContainerName (Port $TargetPort)"

          # ----------------------------------------------------------------
          # [Step B] ìƒˆ ì»¨í…Œì´ë„ˆ ë°°í¬
          # ----------------------------------------------------------------
          
          # í˜¹ì‹œ ë‚¨ì•„ìˆì„ì§€ ëª¨ë¥´ëŠ” ì¢€ë¹„ ì»¨í…Œì´ë„ˆ ì‚­ì œ
          if (docker ps -a -q -f name=$NewContainerName) {
            docker rm -f $NewContainerName
          }

          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          # --network test-net: Nginxì™€ ê°™ì€ ë„¤íŠ¸ì›Œí¬ í•„ìˆ˜!
          docker run -d --name $NewContainerName `
            --network test-net `
            -p ${TargetPort}:5000 `
            --restart always `
            -e Page_Title="Deployment Server" `
            my-app:prod

          # ----------------------------------------------------------------
          # [Step C] í—¬ìŠ¤ ì²´í¬ (ì„œë²„ê°€ ëœ° ë•Œê¹Œì§€ ëŒ€ê¸°)
          # ----------------------------------------------------------------
          Write-Host "Waiting for new container to initialize..."
          Start-Sleep -Seconds 10
          

          # ----------------------------------------------------------------
          # [Step D] Nginx ì„¤ì • íŒŒì¼ êµì²´ (Host íŒŒì¼ ë®ì–´ì“°ê¸°)
          # ----------------------------------------------------------------
          
          # [ì¤‘ìš”] ë‹˜ì´ ë§Œë“œì‹  'ê·¸ í´ë”' ì•ˆì— ìˆëŠ” íŒŒì¼ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.
          $NginxConfPath = "C:\Users\answn\workspace\cicd_practice\nginx\myapp.conf"
          
          if (-not $NewContainerName) {
              Write-Error "âŒ Error: Container Name is empty! Aborting Nginx update."
              exit 1
          }

          # Nginx ì„¤ì • ë‚´ìš© ì‘ì„±
          # upstream ì£¼ì†Œë¥¼ 'ì»¨í…Œì´ë„ˆ ì´ë¦„'($NewContainerName)ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          # ê°™ì€ Docker Network ì•ˆì— ìˆìœ¼ë¯€ë¡œ ì´ë¦„ìœ¼ë¡œ í†µì‹  ê°€ëŠ¥í•©ë‹ˆë‹¤.
          $NewConfigContent = @"
          upstream backend {
              server $NewContainerName:5000;
          }

          server {
              listen 80;
              server_name localhost;

              location / {
                  proxy_pass http://backend;
                  proxy_set_header Host `$host;
                  proxy_set_header X-Real-IP `$remote_addr;
                  proxy_set_header X-Forwarded-For `$proxy_add_x_forwarded_for;
              }
          }
          "@

          # íŒŒì¼ ë®ì–´ì“°ê¸° (ì¸ì½”ë”© ì£¼ì˜)
          Set-Content -Path $NginxConfPath -Value $NewConfigContent -Encoding Ascii
          Write-Host "Updated Nginx config at $NginxConfPath pointing to $NewContainerName"

          # ----------------------------------------------------------------
          # [Step E] Nginx Reload (ë¬´ì¤‘ë‹¨ ìŠ¤ìœ„ì¹­!)
          # ----------------------------------------------------------------
          # í´ë” ë§ˆìš´íŠ¸ê°€ ë˜ì–´ìˆìœ¼ë¯€ë¡œ, íŒŒì¼ì´ ë°”ë€ ê±¸ Nginxë„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          # ë¦¬ë¡œë“œë§Œ í•´ì£¼ë©´ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.
          
          Write-Host "Reloading Nginx..."
          docker exec nginx-proxy nginx -t

          if ($LASTEXITCODE -eq 0) {
              Write-Host "Configuration valid. Reloading Nginx..."
              docker exec nginx-proxy nginx -s reload
              Write-Host "Traffic Switched to $NewContainerName"
          } else {
              Write-Error "âŒ Nginx configuration test failed! Not reloading."
              exit 1
          }
          
          Write-Host "Traffic Switched to $NewContainerName"

          # ----------------------------------------------------------------
          # [Step F] êµ¬ë²„ì „ ì»¨í…Œì´ë„ˆ ì‚­ì œ
          # ----------------------------------------------------------------
          if (docker ps -a -q -f name=$OldContainerName) {
            Write-Host "Removing old container: $OldContainerName"
            docker stop $OldContainerName
            docker rm $OldContainerName
          }