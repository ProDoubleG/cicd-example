name: CD - Blue/Green Deployment (Main)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-blue-green:
    runs-on: self-hosted
    env:
      ROOT_DIR: ${{ secrets.PROJECT_ROOT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Check if Nginx is Online (Port 5005, Endpoint status)
      - name: 1. Pre-flight Check (Nginx Health)
        run: .\scripts\check-health.ps1 -Port 5005 -Endpoint "status"

      # 2. Build image for app deployment
      - name: 2. Build and Tag Deployment Image
        run: |
          docker build --target deploy-image -t my-app:deploy -f app/Dockerfile .

      # 3. Decide target color (blue/green) according to previous nginx config
      - name: 3. Identify Target Slot
        id: slot
        run: |
          $CurrentConfig = docker exec nginx-proxy cat /etc/nginx/conf.d/default.conf
          if ($CurrentConfig -match "app-blue") {
              Write-Host "Active Slot: BLUE -> Target Slot: GREEN"
              echo "target_color=green" >> $env:GITHUB_OUTPUT
              echo "target_port=5002" >> $env:GITHUB_OUTPUT
              echo "old_color=blue" >> $env:GITHUB_OUTPUT
          } else {
              Write-Host "Active Slot: GREEN -> Target Slot: BLUE"
              echo "target_color=blue" >> $env:GITHUB_OUTPUT
              echo "target_port=5001" >> $env:GITHUB_OUTPUT
              echo "old_color=green" >> $env:GITHUB_OUTPUT
          }

      # 4. Start NEW deployment container
      - name: 4. Launch Target Container
        run: |
          $Color = "${{ steps.slot.outputs.target_color }}"
          $Port = "${{ steps.slot.outputs.target_port }}"
          $ContainerName = "app-$Color"

          if (docker ps -a -q -f name=$ContainerName) {
              Write-Host "Stopping existing $ContainerName gracefully..."
              docker stop $ContainerName
              docker rm $ContainerName
          }

          Write-Host "Starting new container: $ContainerName on port $Port"
          docker run -d --name $ContainerName `
            --network myapp-net `
            -p "${Port}:5000" `
            -e Page_Title="Deployment Server ($Color)" `
            --restart always `
            my-app:deploy

      # 5. Health check of new app
      - name: 5. Verify New Instance Health
        run: .\scripts\check-health.ps1 -Port ${{ steps.slot.outputs.target_port }}

      # 6. Switch target of nginx to new app  (Nginx Reload)
      - name: 6. Switch Traffic and Reload Nginx
        run: |
          $Old = "app-${{ steps.slot.outputs.old_color }}"
          $New = "app-${{ steps.slot.outputs.target_color }}"
          
          Write-Host "Switching Nginx traffic: $Old -> $New"
          docker exec nginx-proxy sed -i "s/$Old/$New/g" /etc/nginx/conf.d/default.conf
          
          docker exec nginx-proxy nginx -t
          if ($LASTEXITCODE -eq 0) {
              docker exec nginx-proxy nginx -s reload
              Write-Host "Traffic switched successfully."
          } else {
              Write-Error "Nginx config check failed."
              exit 1
          }

      # 7. Check if target switching was successful  (Port 80)
      - name: 7. Final Verification via Proxy
        run: .\scripts\check-health.ps1 -Port 80

      # 8. Delete deprecated app container
      - name: 8. Cleanup Old Container
        run: |
          $OldContainer = "app-${{ steps.slot.outputs.old_color }}"
          if (docker ps -q -f name=$OldContainer) {
              Write-Host "Retiring old container $OldContainer gracefully..."
              docker stop $OldContainer
              docker rm $OldContainer
          }