name: CD - Blue/Green Deployment (Main)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-blue-green:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ í†µê³¼)
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
            docker network create test-net
          }

      # 2. í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Production Image
        run: docker build --target production -t my-app:prod -f app/Dockerfile .

      # 3. [í•µì‹¬] Blue/Green ë°°í¬ ì „ëµ ì‹¤í–‰
      - name: Blue/Green Deployment Strategy
        run: |
          # ----------------------------------------------------------------
          # [Step A] íƒ€ê²Ÿ ê²°ì • (ëˆ„ê°€ ë²”ì¸ì¸ê°€?)
          # ----------------------------------------------------------------
          Write-Host "----------------------------------------"
          Write-Host "ğŸ” [DEBUG] Starting Deployment Logic..."

          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ID í™•ì¸
          $BlueID = docker ps -q -f name=app-blue
          $GreenID = docker ps -q -f name=app-green
          
          Write-Host "   - Blue Container ID: '$BlueID'"
          Write-Host "   - Green Container ID: '$GreenID'"

          # ë¡œì§: Blueê°€ ì‚´ì•„ìˆìœ¼ë©´ Greenìœ¼ë¡œ, ì•„ë‹ˆë©´ Blueë¡œ
          if ($BlueID) {
            $TargetColor = "green"
            $TargetPort = "5002"
            $OldColor = "blue"
          } else {
            # Blueê°€ ì—†ê±°ë‚˜ ì£½ì–´ìˆìœ¼ë©´ ë¬´ì¡°ê±´ Blue ë°°í¬ (ê¸°ë³¸ê°’)
            $TargetColor = "blue"
            $TargetPort = "5001"
            $OldColor = "green"
          }

          $NewContainerName = "app-$TargetColor"
          $OldContainerName = "app-$OldColor"

          # ----------------------------------------------------------------
          # [Step B] ì•ˆì „ì¥ì¹˜ (ë³€ìˆ˜ ê²€ì¦)
          # ----------------------------------------------------------------
          # ë§Œì•½ ë³€ìˆ˜ê°€ ë¹„ì–´ìˆë‹¤ë©´ ì¦‰ì‹œ ì—ëŸ¬ë¥¼ ë‚´ê³  ë©ˆì¶¤
          if ([string]::IsNullOrWhiteSpace($NewContainerName)) {
            Write-Error "âŒ FATAL ERROR: Target Container Name is EMPTY!"
            exit 1
          }

          Write-Host "âœ… Target Decided: $NewContainerName (Port $TargetPort)"
          Write-Host "----------------------------------------"

          # ----------------------------------------------------------------
          # [Step C] ìƒˆ ì»¨í…Œì´ë„ˆ ë°°í¬
          # ----------------------------------------------------------------
          Write-Host "ğŸš€ Deploying $NewContainerName..."

          if (docker ps -a -q -f name=$NewContainerName) {
            docker rm -f $NewContainerName
          }

          # [í˜ì´ì§€ ì œëª© í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ë¨]
          docker run -d --name $NewContainerName `
            --network test-net `
            -p ${TargetPort}:5000 `
            -e Page_Title="Deployment Server" `
            --restart always `
            my-app:prod

          Write-Host "â³ Waiting for container to initialize..."
          Start-Sleep -Seconds 5

          # ----------------------------------------------------------------
          # [Step D] Nginx ì„¤ì • íŒŒì¼ êµì²´ (ë¬¸ìì—´ ì¡°í•© ë°©ì‹ ë³€ê²½)
          # ----------------------------------------------------------------
          $NginxConfPath = "C:\Users\answn\workspace\cicd_practice\nginx\myapp.conf"
          
          # [ì¤‘ìš”] ë³€ìˆ˜ë¥¼ ë¬¸ìì—´ ë°–ì—ì„œ ë¯¸ë¦¬ ì¡°í•©í•˜ì—¬ ì˜¤íƒ€/ì¸ì‹ ì˜¤ë¥˜ ë°©ì§€
          $UpstreamServer = "server $NewContainerName:5000;"
          
          # ë‚´ìš© ì‘ì„±
          $NewConfigContent = @"
          upstream backend {
              $UpstreamServer
          }

          server {
              listen 80;
              server_name localhost;

              location / {
                  proxy_pass http://backend;
                  proxy_set_header Host `$host;
                  proxy_set_header X-Real-IP `$remote_addr;
                  proxy_set_header X-Forwarded-For `$proxy_add_x_forwarded_for;
              }
          }
          "@

          # [ë””ë²„ê¹…] ì‹¤ì œë¡œ íŒŒì¼ì— ì“°ì¼ ë‚´ìš©ì„ í™”ë©´ì— ë³´ì—¬ì¤Œ
          Write-Host "ğŸ“„ [DEBUG] Writing Nginx Config Content:"
          Write-Host $NewConfigContent
          Write-Host "----------------------------------------"

          Set-Content -Path $NginxConfPath -Value $NewConfigContent -Encoding Ascii
          Write-Host "Updated Nginx config at $NginxConfPath"

          # ----------------------------------------------------------------
          # [Step E] Nginx Reload (ë¬´ì¤‘ë‹¨ ìŠ¤ìœ„ì¹­)
          # ----------------------------------------------------------------
          Write-Host "Testing Nginx configuration..."
          docker exec nginx-proxy nginx -t
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "Configuration valid. Reloading Nginx..."
              docker exec nginx-proxy nginx -s reload
              Write-Host "ğŸ‰ Traffic Switched to $NewContainerName"
          } else {
              Write-Error "âŒ Nginx configuration test failed! Not reloading."
              # ì„¤ì • íŒŒì¼ì´ ì˜ëª»ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì „ ì»¨í…Œì´ë„ˆë¥¼ ì‚´ë ¤ë‘ê¸° ìœ„í•´ ì—¬ê¸°ì„œ ë©ˆì¶¤
              exit 1
          }

          # ----------------------------------------------------------------
          # [Step F] êµ¬ë²„ì „ ì»¨í…Œì´ë„ˆ ì‚­ì œ
          # ----------------------------------------------------------------
          if (docker ps -a -q -f name=$OldContainerName) {
            Write-Host "Removing old container: $OldContainerName"
            docker stop $OldContainerName
            docker rm $OldContainerName
          }