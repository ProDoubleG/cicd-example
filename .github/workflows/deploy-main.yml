name: CD - Blue/Green Deployment (Main)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-blue-green:
    runs-on: self-hosted
    env:
      ROOT_DIR: ${{ secrets.PROJECT_ROOT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 인프라 체크: Nginx가 살아있는지 스크립트로 확인 (Port 5004, Endpoint status)
      - name: 1. Pre-flight Check (Nginx Health)
        run: .\scripts\check-health.ps1 -Port 5004 -Endpoint "status"

      # 2. 이미지 빌드 및 태깅
      - name: 2. Build and Tag Production Image
        run: |
          $ImageTag = "my-app:${{ github.sha }}"
          docker build --target production -t $ImageTag -f app/Dockerfile .
          docker tag $ImageTag my-app:prod

      # 3. 배포 타겟 결정 (Nginx 컨테이너 내부 설정을 읽어 판단)
      - name: 3. Identify Target Slot
        id: slot
        run: |
          $CurrentConfig = docker exec nginx-proxy cat /etc/nginx/conf.d/default.conf
          if ($CurrentConfig -match "app-blue") {
              Write-Host "Active Slot: BLUE -> Target Slot: GREEN"
              echo "target_color=green" >> $env:GITHUB_OUTPUT
              echo "target_port=5002" >> $env:GITHUB_OUTPUT
              echo "old_color=blue" >> $env:GITHUB_OUTPUT
          } else {
              Write-Host "Active Slot: GREEN -> Target Slot: BLUE"
              echo "target_color=blue" >> $env:GITHUB_OUTPUT
              echo "target_port=5001" >> $env:GITHUB_OUTPUT
              echo "old_color=green" >> $env:GITHUB_OUTPUT
          }

      # 4. 신규 컨테이너 기동 (Graceful Shutdown 적용)
      - name: 4. Launch Target Container
        run: |
          $Color = "${{ steps.slot.outputs.target_color }}"
          $Port = "${{ steps.slot.outputs.target_port }}"
          $ContainerName = "app-$Color"

          if (docker ps -a -q -f name=$ContainerName) {
              Write-Host "Stopping existing $ContainerName gracefully..."
              docker stop $ContainerName
              docker rm $ContainerName
          }

          Write-Host "Starting new container: $ContainerName on port $Port"
          docker run -d --name $ContainerName `
            --network test-net `
            -p "${Port}:5000" `
            -e Page_Title="Production Server ($Color)" `
            --restart always `
            my-app:prod

      # 5. 신규 컨테이너 헬스 체크 (스크립트 활용)
      - name: 5. Verify New Instance Health
        run: .\scripts\check-health.ps1 -Port ${{ steps.slot.outputs.target_port }}

      # 6. 트래픽 전환 (Nginx Reload)
      - name: 6. Switch Traffic and Reload Nginx
        run: |
          $Old = "app-${{ steps.slot.outputs.old_color }}"
          $New = "app-${{ steps.slot.outputs.target_color }}"
          
          Write-Host "Switching Nginx traffic: $Old -> $New"
          docker exec nginx-proxy sed -i "s/$Old/$New/g" /etc/nginx/conf.d/default.conf
          
          docker exec nginx-proxy nginx -t
          if ($LASTEXITCODE -eq 0) {
              docker exec nginx-proxy nginx -s reload
              Write-Host "Traffic switched successfully."
          } else {
              Write-Error "Nginx config check failed."
              exit 1
          }

      # 7. 최종 서비스 검증 (Port 80)
      - name: 7. Final Verification via Proxy
        run: .\scripts\check-health.ps1 -Port 80

      # 8. 구버전 제거 (Graceful)
      - name: 8. Cleanup Old Container
        run: |
          $OldContainer = "app-${{ steps.slot.outputs.old_color }}"
          if (docker ps -q -f name=$OldContainer) {
              Write-Host "Retiring old container $OldContainer gracefully..."
              docker stop $OldContainer
              docker rm $OldContainer
          }