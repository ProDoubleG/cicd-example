name: CI - Integration Test

# ì–¸ì œ ì‹¤í–‰ë ì§€ ì •ì˜ (Trigger)
on:
  push:
    branches: [ "stage" ]       # dev ë¸Œëœì¹˜ì— ì½”ë“œê°€ ì˜¬ë¼ì˜¤ê±°ë‚˜
  pull_request:
    branches: [ "stage" ]     # stageë¡œ í•©ì¹˜ë ¤ê³  PRì„ ë‚ ë¦´ ë•Œ

jobs:
  test:
    # ê°€ì¥ ì¤‘ìš”: GitHub ì„œë²„ê°€ ì•„ë‹ˆë¼ 'ë‚´ ì»´í“¨í„°'ì—ì„œ ì‹¤í–‰í•¨
    runs-on: self-hosted

    steps:
      # 1. GitHubì— ìˆëŠ” ì½”ë“œë¥¼ ë‚´ ì»´í“¨í„° ì‘ì—… í´ë”ë¡œ ê°€ì ¸ì˜´
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. í…ŒìŠ¤íŠ¸ìš© ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Test Image
        run: docker build -t my-app:test ./app

      # 3. í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í¬íŠ¸ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ 5001ë²ˆ ì‚¬ìš©)
      # 1. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (PowerShell ë°©ì‹)
      - name: Run Test Container
        run: |
          docker rm -f app-test 2> $null
          docker run -d --name app-test -p 5001:5000 my-app:test

      # 2. ì„œë²„ ëŒ€ê¸° (PowerShell ë°©ì‹)
      - name: Wait for Server
        run: Start-Sleep -Seconds 5

      # 3. í…ŒìŠ¤íŠ¸ ë¡œì§ (ì™„ì „í•œ PowerShell ë¬¸ë²•)
      - name: Execute Test Logic
        run: |
          Write-Host "ğŸ§ª Testing Core Function..."
          try {
            $Response = Invoke-RestMethod -Uri "http://localhost:5001/core" -Method Get
            Write-Host "   Response: $Response"
            
            if ($Response -eq "Success") {
              Write-Host "   âœ… Core Function Passed!" -ForegroundColor Green
            } else {
              Write-Error "   âŒ Core Function Failed. Expected 'Success', got '$Response'"
              exit 1
            }
          } catch {
            Write-Error "   âŒ Connection Failed: $_"
            exit 1
          }

          Write-Host "ğŸ§ª Testing Legacy Feature..."
          try {
            $Response = Invoke-RestMethod -Uri "http://localhost:5001/legacy" -Method Get
            Write-Host "   Response: $Response"

            if ($Response -eq "Response A") {
              Write-Host "   âœ… Legacy Feature Passed!" -ForegroundColor Green
            } else {
              Write-Error "   âŒ Legacy Feature Failed. Expected 'Response A', got '$Response'"
              exit 1
            }
          } catch {
            Write-Error "   âŒ Connection Failed: $_"
            exit 1
          }