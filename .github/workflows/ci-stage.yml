name: CI - Integration Test (Stage)

on:
  push:
    branches: [ "stage" ]
  pull_request:
    branches: [ "stage" ]

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 네트워크 생성 (이미 있으면 에러 안나게 처리)
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
            docker network create test-net
          }

      # 2. 서버용 이미지 빌드 (로그 확인을 위해 에러 무시 없음)
      - name: Build Production Image
        run: docker build --target production -t my-app:prod -f app/Dockerfile .

      # 3. [확인] 이미지가 진짜 만들어졌는지 확인
      - name: Check Built Images
        run: docker images my-app

      # 4. 테스트 러너 이미지 빌드
      - name: Build Test Runner Image
        run: docker build --target test-image -t my-app:tester -f app/Dockerfile .

      # 5. [중요] 앱 컨테이너 실행 (에러 숨기기 제거!)
      # 여기서 에러가 나면 바로 멈추고 이유를 알려줄 겁니다.
      - name: Run App Container
        run: |
          if (docker ps -a -q -f name=app-test) {
            Write-Host "Found existing container. Removing..."
            docker stop app-test
            docker rm app-test
          }

          docker run -d --name app-test --network test-net -p 5001:5000 my-app:prod
      # 6. 서버 대기
      - name: Wait for Server
        run: Start-Sleep -Seconds 5

      # 7. 상태 확인 (이제는 확실히 보일 겁니다)
      - name: Check App Logs
        run: |
          docker ps -a
          docker logs app-test

      # 8. 테스트 실행
      - name: Run Tests
        run: |
          docker run --rm --network test-net `
            -e App_URL="http://app-test:5000" `
            my-app:tester

      # 9. 뒷정리
      - name: Cleanup
        if: always()
        run: |
          if (docker ps -a -q -f name=app-test) {
            docker stop app-test
            docker rm app-test
          }
      # ----------------------------------------------------------------
      # [Phase 2] 스테이징 배포 (테스트 통과 시에만 실행!)
      # ----------------------------------------------------------------

      # 7. 사람이 들어갈 서버 띄우기 (Port 5002)
      # 위 단계(Run Automated Tests)가 실패하면 이 단계는 실행되지 않음 (GitHub Actions 기본 동작)
      - name: Deploy to Staging
        run: |
          Write-Host "Integration Completed! Deploying to Staging Environment..."
          
          # 기존에 켜져있던 스테이징 서버가 있다면 내리고 교체 (업데이트)
          if (docker ps -a -q -f name=app-stage) {
            Write-Host "Stopping old staging server..."
            docker stop app-stage
            docker rm app-stage
          }

          # 스테이징 서버 실행 (5002번 포트 사용!)
          # -d: 백그라운드 실행 (계속 켜져 있음)
          # --restart always: 혹시 죽으면 다시 살려라
          docker run -d --name app-stage --network test-net -p 5002:5000 --restart always my-app:prod
          
          Write-Host "Staging Server is Live at http://localhost:5002"