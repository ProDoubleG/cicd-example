name: CI - Integration Test (Stage)

on:
  push:
    branches: [ "stage" ]
  pull_request:
    branches: [ "stage" ]

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 네트워크 생성 (이미 있으면 에러 안나게 처리)
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
            docker network create test-net
          }

      # 2. 서버용 이미지 빌드 (로그 확인을 위해 에러 무시 없음)
      - name: Build Production Image
        run: docker build --target production -t my-app:prod -f app/Dockerfile .

      # 3. [확인] 이미지가 진짜 만들어졌는지 확인
      - name: Check Built Images
        run: docker images my-app

      # 4. 테스트 러너 이미지 빌드
      - name: Build Test Runner Image
        run: docker build --target test-image -t my-app:tester -f app/Dockerfile .

      # 5. [중요] 앱 컨테이너 실행 (에러 숨기기 제거!)
      # 여기서 에러가 나면 바로 멈추고 이유를 알려줄 겁니다.
      - name: Run App Container
        run: |
          docker rm -f app-test 2> $null
          docker run -d --name app-test --network test-net -p 5001:5000 my-app:prod

      # 6. 서버 대기
      - name: Wait for Server
        run: Start-Sleep -Seconds 5

      # 7. 상태 확인 (이제는 확실히 보일 겁니다)
      - name: Check App Logs
        run: |
          docker ps -a
          docker logs app-test

      # 8. 테스트 실행
      - name: Run Tests
        run: |
          docker run --rm --network test-net `
            -e App_URL="http://app-test:5000" `
            my-app:tester

      # 9. 뒷정리
      - name: Cleanup
        if: always()
        run: docker rm -f app-test
        continue-on-error: true