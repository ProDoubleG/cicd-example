name: CI - Integration Test (Stage)

on:
  push:
    branches: [ "stage" ]
  pull_request:
    branches: [ "stage" ]

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Network Setup
      - name: 1. Create Network
        run: |
          if (-not (docker network ls -q -f name=myapp-net)) {
            docker network create myapp-net
          }

      # 2. Build Images (Production & Tester)
      # my-app:stage and my-app:deploy is actually same image with different tag
      # but just to avoid confusion, the tag names were differentiated
      - name: 2. Build Images
        run: |
          Write-Host "Building Tester image..."
          docker build --target deploy-image -t my-app:stage -f app/Dockerfile .

          Write-Host "Building Tester image..."
          docker build --target test-image -t my-app:test -f app/Dockerfile .

      # 3. Run Test App (Port 5005)
      - name: 3. Run Test Container
        run: |
          $Name = "app-test"
          if (docker ps -a -q -f name=$Name) { 
              Write-Host "Stopping existing $Name gracefully..."
              docker stop $Name
              docker rm $Name 
          }
          
          Write-Host "Launching $Name for testing..."
          docker run -d --name $Name --network myapp-net -p 5005:5000 my-app:stage

      # 4. Health Check
      - name: 4. Verify Test App Health
        run: .\scripts\check-health.ps1 -Port 5005

      # 5. Run Functional Tests
      - name: 5. Execute Automated Tests
        run: |
          docker run --rm --network myapp-net `
            -e App_URL="http://app-test:5000" `
            my-app:test

      # 6. Cleanup Test Environment
      - name: 6. Cleanup Test Container
        if: always()
        run: |
          if (docker ps -a -q -f name=app-test) { 
              docker stop app-test
              docker rm app-test 
          }

      #######################################################################
      ########## Phase 2: Deploy to Staging (Only if tests passed) ##########
      #######################################################################
      - name: 7. Deploy to Staging Environment (Port 5003)
        run: |
          $Name = "app-stage"
          Write-Host "Tests passed! Updating Staging server..."
          
          if (docker ps -a -q -f name=$Name) {
              Write-Host "Stopping current staging server gracefully..."
              docker stop $Name
              docker rm $Name
          }

          docker run -d --name $Name `
            --network myapp-net `
            -p 5003:5000 `
            -e Page_Title="On-Stage Server" `
            --restart always `
            my-app:stage

      # 8. Final Health Check for Stage
      - name: 8. Verify Staging Health
        run: .\scripts\check-health.ps1 -Port 5003