name: CI - Integration Test (Stage)

on:
  push:
    branches: [ "stage" ]
  pull_request:
    branches: [ "stage" ]

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. [네트워크 생성] PowerShell에서 에러 없이 안전하게 만드는 방법
      # "test-net이 없으면 만들고, 있으면 넘어가라"
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
            docker network create test-net
          }

      # 2. 이미지 빌드 (멀티 스테이지)
      - name: Build Test Image
        run: |
          docker build --target test-image -t my-app:test -f app/Dockerfile .

      # 3. 앱 컨테이너 실행
      # --network test-net : 우리만의 랜선에 꽂기
      # --name app-test    : 이 이름이 곧 도메인 주소가 됨
      - name: Run App Container
        run: |
          docker rm -f app-test 2> $null
          docker run -d --name app-test --network test-net -p 5001:5000 my-app:test
        continue-on-error: true

      # 4. 서버 대기 (넉넉하게 5초)
      - name: Wait for Server
        run: Start-Sleep -Seconds 5

      # 5. [디버깅] 혹시 앱이 죽었는지 확인하기 위해 로그 출력
      - name: Check App Status
        run: docker ps -a | findstr app-test

      # 6. [핵심] 테스트 실행 (컨테이너 간 통신)
      # App_URL을 'http://app-test:5000'으로 설정해야 함 (내부 포트 사용!)
      - name: Run Tests
        run: |
          docker run --rm --network test-net `
            -e App_URL="http://app-test:5000" `
            my-app:test

      # 7. 뒷정리
      - name: Cleanup
        if: always()
        run: |
          docker rm -f app-test
          # 네트워크는 다른 프로젝트랑 겹칠 수 있으니 굳이 삭제 안 해도 됨 (선택 사항)
          # docker network rm test-net 
        continue-on-error: true