name: CI - Integration Test (Stage)

on:
  push:
    branches: [ "stage" ]
  pull_request:
    branches: [ "stage" ]

jobs:
  test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 도커 네트워크 생성 (앱과 테스트 컨테이너가 서로 통신하기 위해)
      - name: Create Network
        run: |
          if (-not (docker network ls -q -f name=test-net)) {
              docker network create test-net
            }

      # 2. 테스트용 앱 이미지 빌드
      - name: Build App Image
        run: docker build -t my-app:test ./app

      # 3. 앱 컨테이너 실행 (test-net 네트워크에 연결!)
      - name: Run App Container
        run: |
          docker rm -f app-test
          # --network test-net: 네트워크 연결
          # --name app-test: 이 이름으로 접속 가능
          docker run -d --name app-test --network test-net -p 5001:5000 my-app:test
        continue-on-error: true

      # 4. 서버 뜰 때까지 대기
      - name: Wait for Server
        run: Start-Sleep -Seconds 5

      # 5. [핵심] 테스트 실행 (도커 안에서 pip 설치하고 실행)
      - name: Run Tests in Docker
        # 윈도우 경로 호환성을 위해 Powershell 변수 사용 ($PWD)
        run: |
          docker run --rm --network test-net `
            -v ${PWD}/tests:/tests `
            -e App_URL="http://app-test:5000" `
            python:3.9-slim `
            /bin/bash -c "pip install pytest requests && pytest -v /tests/integration_test.py"

      # 6. 뒷정리
      - name: Cleanup
        if: always()
        run: |
          docker rm -f app-test
          docker network rm test-net
        continue-on-error: true