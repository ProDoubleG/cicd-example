name: CI - Integration Test

# 언제 실행될지 정의 (Trigger)
on:
  push:
    branches: [ "dev" ]       # dev 브랜치에 코드가 올라오거나
  pull_request:
    branches: [ "stage" ]     # stage로 합치려고 PR을 날릴 때

jobs:
  test:
    # 가장 중요: GitHub 서버가 아니라 '내 컴퓨터'에서 실행함
    runs-on: self-hosted

    steps:
      # 1. GitHub에 있는 코드를 내 컴퓨터 작업 폴더로 가져옴
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 테스트용 도커 이미지 빌드
      - name: Build Test Image
        run: docker build -t my-app:test ./app

      # 3. 테스트 컨테이너 실행 (포트 충돌 방지를 위해 5001번 사용)
      - name: Run Test Container
        run: |
          # 혹시 기존에 찌꺼기가 있으면 삭제
          docker rm -f app-test || true
          # 백그라운드 실행 (-d)
          docker run -d --name app-test -p 5001:5000 my-app:test

      # 4. 서버가 뜰 때까지 잠깐 대기 (3초)
      - name: Wait for Server
        run: sleep 3

      # 5. 테스트 스크립트 실행 (핵심 로직)
      - name: Execute Test Logic
        run: |
          echo "Testing Core Function..."
          CORE_RES=$(curl -s http://localhost:5001/core)
          if [ "$CORE_RES" == "Success" ]; then
            echo "Core Function Passed!"
          else
            echo "Core Function Failed. Expected 'Success', got '$CORE_RES'"
            exit 1
          fi

          echo "Testing Legacy Feature..."
          LEGACY_RES=$(curl -s http://localhost:5001/legacy)
          if [ "$LEGACY_RES" == "Response A" ]; then
            echo "Legacy Feature Passed!"
          else
            echo "Legacy Feature Failed. Expected 'Response A', got '$LEGACY_RES'"
            exit 1
          fi

      # 6. 뒷정리 (테스트가 실패해도 무조건 실행)
      - name: Cleanup
        if: always()
        run: docker rm -f app-test